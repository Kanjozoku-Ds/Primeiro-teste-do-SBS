<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Gestor de Insumos</title>
    <!-- Tailwind CSS (Estilos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React e ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel para ler JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Ajustes finos para rolagem mobile */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        // Importando ícones individualmente para garantir compatibilidade
        import { 
            Plus, Trash2, Scale, Calculator, Package, AlertCircle, Save, DollarSign, 
            ChefHat, ArrowRight, List, Flame, UtensilsCrossed, Building2, TrendingUp, 
            Wallet, ShoppingCart, History, MinusCircle, CheckCircle, Factory, Tag, 
            Boxes, AlertTriangle, RefreshCw, X, ChevronRight, Menu 
        } from 'https://esm.sh/lucide-react@0.344.0';

        // --- COMPONENTES UI ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        // Componente Modal Genérico
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-sm overflow-hidden animate-in zoom-in-95 duration-200">
                        <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                            <h3 className="font-bold text-slate-700">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5"/></button>
                        </div>
                        <div className="p-4">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- FORMATAÇÃO AVANÇADA ---
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const formatPercent = (value) => `${value.toFixed(1)}%`;

        const formatPrecision = (value) => {
            return new Intl.NumberFormat('pt-BR', { 
                style: 'currency', 
                currency: 'BRL', 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 6 
            }).format(value);
        };

        function App() {
            const [activeTab, setActiveTab] = useState('cadastro'); 
            
            // --- ESTADO DOS INSUMOS ---
            const [insumos, setInsumos] = useState([]);
            const [formInsumo, setFormInsumo] = useState({
                nome: '', precoCompra: '', quantidadeCompra: '', unidadeCompra: 'kg', tipo: 'compra' 
            });
            const [previewCalculo, setPreviewCalculo] = useState(null);
            
            // Modais
            const [modalReposicao, setModalReposicao] = useState(null); 
            const [formReposicao, setFormReposicao] = useState({ qtd: '', preco: '' });
            const [itemParaExcluir, setItemParaExcluir] = useState(null);

            // --- ESTADO DOS PRODUTOS (Receitas) ---
            const [produtos, setProdutos] = useState([]);
            const [formProduto, setFormProduto] = useState({
                nome: '', ingredientes: [], isPreparo: false, rendimentoFinal: '', unidadeRendimento: 'kg'
            });
            const [ingredienteSelecionado, setIngredienteSelecionado] = useState('');
            const [qtdIngrediente, setQtdIngrediente] = useState('');

            // --- ESTADO PRODUÇÃO ---
            const [producaoQtd, setProducaoQtd] = useState('');
            const [produtoEmProducao, setProdutoEmProducao] = useState(null);
            const [maxProducao, setMaxProducao] = useState(0);

            // --- ESTADO DOS CUSTOS FIXOS ---
            const [custosFixos, setCustosFixos] = useState([]);
            const [formCustoFixo, setFormCustoFixo] = useState({ nome: '', valor: '' });
            const [faturamentoEstimado, setFaturamentoEstimado] = useState(''); 

            // --- PRECIFICAÇÃO E VENDAS ---
            const [precosVenda, setPrecosVenda] = useState({}); 
            const [carrinho, setCarrinho] = useState([]); 
            const [historicoVendas, setHistoricoVendas] = useState([]);
            const [metodoPagamento, setMetodoPagamento] = useState('dinheiro');
            const [filtroEstoque, setFiltroEstoque] = useState('todos'); 

            // Unidades
            const unidades = [
                { value: 'kg', label: 'Quilogramas (kg)', base: 'g', factor: 1000 },
                { value: 'g', label: 'Gramas (g)', base: 'g', factor: 1 },
                { value: 'l', label: 'Litros (l)', base: 'ml', factor: 1000 },
                { value: 'ml', label: 'Mililitros (ml)', base: 'ml', factor: 1 },
                { value: 'un', label: 'Unidade (un)', base: 'un', factor: 1 },
                { value: 'dz', label: 'Dúzia (dz)', base: 'un', factor: 12 },
                { value: 'min', label: 'Minutos (min)', base: 'min', factor: 1 },
                { value: 'h', label: 'Horas (h)', base: 'min', factor: 60 },
            ];

            // Cálculos Globais
            const totalCustosFixos = custosFixos.reduce((acc, curr) => acc + curr.valor, 0);
            const percentualCustoFixo = faturamentoEstimado > 0 ? (totalCustosFixos / parseFloat(faturamentoEstimado)) * 100 : 0;

            // --- LÓGICA DE INSUMOS ---
            useEffect(() => {
                if (formInsumo.precoCompra && formInsumo.quantidadeCompra && formInsumo.unidadeCompra) {
                    const preco = parseFloat(formInsumo.precoCompra);
                    const qtd = parseFloat(formInsumo.quantidadeCompra);
                    const unidadeSelecionada = unidades.find(u => u.value === formInsumo.unidadeCompra);
                    if (preco > 0 && qtd > 0 && unidadeSelecionada) {
                        const qtdTotalBase = qtd * unidadeSelecionada.factor;
                        const custoPorBase = preco / qtdTotalBase;
                        setPreviewCalculo({ qtdTotalBase, unidadeBase: unidadeSelecionada.base, custoPorBase });
                        return;
                    }
                }
                setPreviewCalculo(null);
            }, [formInsumo]);

            const handleSubmitInsumo = (e) => {
                e.preventDefault();
                if (!previewCalculo) return;
                const novoInsumo = {
                    id: Date.now(),
                    nome: formInsumo.nome,
                    tipo: formInsumo.tipo, 
                    compra: { preco: parseFloat(formInsumo.precoCompra), qtd: parseFloat(formInsumo.quantidadeCompra), unidade: formInsumo.unidadeCompra },
                    base: { custo: previewCalculo.custoPorBase, unidade: previewCalculo.unidadeBase },
                    estoqueAtual: previewCalculo.qtdTotalBase
                };
                setInsumos([novoInsumo, ...insumos]);
                setFormInsumo(prev => ({ ...prev, nome: '', precoCompra: '', quantidadeCompra: '', unidadeCompra: 'kg' }));
                setPreviewCalculo(null);
            };

            const handleRestock = (e) => {
                e.preventDefault();
                if (!modalReposicao || !formReposicao.qtd || !formReposicao.preco) return;

                const insumoAlvo = insumos.find(i => i.id === modalReposicao.id);
                if (!insumoAlvo) return;

                const novaQtdCompra = parseFloat(formReposicao.qtd);
                const novoPrecoTotal = parseFloat(formReposicao.preco);
                const unidadeRef = unidades.find(u => u.value === modalReposicao.unidadeCompra);

                if (novaQtdCompra <= 0 || novoPrecoTotal <= 0 || !unidadeRef) return;

                const novaQtdBase = novaQtdCompra * unidadeRef.factor;

                const valorEstoqueAtual = insumoAlvo.estoqueAtual * insumoAlvo.base.custo;
                const novoEstoqueTotal = insumoAlvo.estoqueAtual + novaQtdBase;
                const valorBaseCorrigido = valorEstoqueAtual < 0 ? 0 : valorEstoqueAtual; 
                const novoCustoTotal = valorBaseCorrigido + novoPrecoTotal;
                const novoCustoMedio = novoEstoqueTotal > 0 ? novoCustoTotal / novoEstoqueTotal : insumoAlvo.base.custo;

                const insumosAtualizados = insumos.map(i => {
                    if (i.id === modalReposicao.id) {
                        return {
                            ...i,
                            estoqueAtual: novoEstoqueTotal,
                            base: { ...i.base, custo: novoCustoMedio },
                            compra: { ...i.compra, preco: novoPrecoTotal, qtd: novaQtdCompra } 
                        };
                    }
                    return i;
                });

                setInsumos(insumosAtualizados);
                setModalReposicao(null);
                setFormReposicao({ qtd: '', preco: '' });
            };

            const confirmarExclusao = () => {
                if (!itemParaExcluir) return;

                if (itemParaExcluir.tipo === 'insumo') {
                    setInsumos(insumos.filter(i => i.id !== itemParaExcluir.id));
                } else if (itemParaExcluir.tipo === 'produto') {
                    setProdutos(produtos.filter(p => p.id !== itemParaExcluir.id));
                } else if (itemParaExcluir.tipo === 'custoFixo') {
                    setCustosFixos(custosFixos.filter(c => c.id !== itemParaExcluir.id));
                }

                setItemParaExcluir(null);
            };

            // --- LÓGICA DE RECEITAS ---
            const adicionarIngredienteAoProduto = () => {
                if (!ingredienteSelecionado || !qtdIngrediente) return;
                const insumoOriginal = insumos.find(i => i.id.toString() === ingredienteSelecionado);
                if (!insumoOriginal) return;
                const qtd = parseFloat(qtdIngrediente);
                const custoCalculado = qtd * insumoOriginal.base.custo;
                setFormProduto(prev => ({
                    ...prev,
                    ingredientes: [...prev.ingredientes, {
                        tempId: Date.now(), insumoId: insumoOriginal.id, nome: insumoOriginal.nome,
                        unidade: insumoOriginal.base.unidade, qtdUsada: qtd, custoCalculado, tipo: insumoOriginal.tipo
                    }]
                }));
                setIngredienteSelecionado(''); setQtdIngrediente('');
            };

            const removerIngredienteDoProduto = (tempId) => {
                setFormProduto(prev => ({
                    ...prev,
                    ingredientes: prev.ingredientes.filter(i => i.tempId !== tempId)
                }));
            };

            const custoTotalProdutoAtual = formProduto.ingredientes.reduce((acc, curr) => acc + curr.custoCalculado, 0);

            const salvarProduto = () => {
                if (!formProduto.nome || formProduto.ingredientes.length === 0) return;
                
                if (formProduto.isPreparo) {
                    const uni = unidades.find(u => u.value === formProduto.unidadeRendimento);
                    const rendimentoBase = parseFloat(formProduto.rendimentoFinal) * uni.factor;
                    const custoUnitario = rendimentoBase > 0 ? custoTotalProdutoAtual / rendimentoBase : 0;
                    
                    const novoPreparoInsumo = {
                        id: Date.now(), nome: `${formProduto.nome} (PP)`, tipo: 'preparo', compra: null,
                        base: { custo: custoUnitario, unidade: uni.base },
                        estoqueAtual: 0,
                        receitaIdRef: Date.now()
                    };
                    setInsumos([novoPreparoInsumo, ...insumos]);
                }

                const novoProduto = {
                    id: formProduto.isPreparo ? Date.now() : Date.now() + 1,
                    nome: formProduto.nome,
                    isPreparo: formProduto.isPreparo,
                    ingredientes: [...formProduto.ingredientes],
                    custoTotal: custoTotalProdutoAtual,
                    estoqueAtual: 0,
                    rendimentoPadrao: formProduto.isPreparo ? parseFloat(formProduto.rendimentoFinal) : 1,
                    unidadeRendimento: formProduto.unidadeRendimento
                };
                setProdutos([novoProduto, ...produtos]);
                setFormProduto({ nome: '', ingredientes: [], isPreparo: false, rendimentoFinal: '', unidadeRendimento: 'kg' });
            };

            // --- LÓGICA DE PRODUÇÃO ---
            const calcularMaximoProducao = (produto) => {
                let limit = Infinity;
                produto.ingredientes.forEach(ing => {
                    const insumo = insumos.find(i => i.id === ing.insumoId);
                    if (insumo) {
                        if (insumo.estoqueAtual <= 0) {
                            limit = 0;
                        } else {
                            const possible = Math.floor(insumo.estoqueAtual / ing.qtdUsada);
                            if (possible < limit) limit = possible;
                        }
                    } else {
                        limit = 0; 
                    }
                });
                return limit === Infinity ? 0 : limit;
            };

            const iniciarProducao = (produto) => {
                const max = calcularMaximoProducao(produto);
                setMaxProducao(max);
                setProdutoEmProducao(produto.id);
                setProducaoQtd('');
            };

            const handleProduzir = (produto) => {
                const qtdProduzir = parseFloat(producaoQtd);
                if (!qtdProduzir || qtdProduzir <= 0) return;
                if (qtdProduzir > maxProducao) {
                    alert(`Estoque insuficiente. Máximo: ${maxProducao}`);
                    return;
                }

                const insumosAtualizados = [...insumos];
                
                produto.ingredientes.forEach(ing => {
                    const insumoNoEstoque = insumosAtualizados.find(i => i.id === ing.insumoId);
                    if (insumoNoEstoque) {
                        insumoNoEstoque.estoqueAtual -= (ing.qtdUsada * qtdProduzir);
                    }
                });
                setInsumos(insumosAtualizados); 

                if (produto.isPreparo) {
                    const insumosPosProducao = insumosAtualizados.map(i => {
                        if (i.nome === `${produto.nome} (PP)`) {
                            const uni = unidades.find(u => u.value === produto.unidadeRendimento);
                            const rendimentoPorReceita = produto.rendimentoPadrao * (uni ? uni.factor : 1);
                            return { ...i, estoqueAtual: i.estoqueAtual + (rendimentoPorReceita * qtdProduzir) };
                        }
                        return i;
                    });
                    setInsumos(insumosPosProducao);
                } else {
                    const produtosAtualizados = produtos.map(p => {
                        if (p.id === produto.id) {
                            return { ...p, estoqueAtual: p.estoqueAtual + qtdProduzir };
                        }
                        return p;
                    });
                    setProdutos(produtosAtualizados);
                }

                setProdutoEmProducao(null);
                alert(`Produção de ${qtdProduzir}x ${produto.nome} realizada com sucesso!`);
            };

            // --- LÓGICA PDV ---
            const handlePrecoChange = (id, val) => setPrecosVenda(prev => ({ ...prev, [id]: parseFloat(val) }));

            const adicionarAoCarrinho = (item, origem) => {
                const preco = precosVenda[item.id] || 0;
                if (preco <= 0) return;

                const itemNoCarrinho = carrinho.find(i => i.idOriginal === item.id);
                const qtdCarrinho = itemNoCarrinho ? itemNoCarrinho.quantidade : 0;
                
                if (item.estoqueAtual - qtdCarrinho <= 0) {
                    alert("Estoque insuficiente para venda!");
                    return;
                }

                const itemExistente = carrinho.find(i => i.idOriginal === item.id && i.origem === origem);
                if (itemExistente) {
                    setCarrinho(carrinho.map(i => i.idOriginal === item.id && i.origem === origem ? { ...i, quantidade: i.quantidade + 1, totalItem: (i.quantidade + 1) * preco } : i));
                } else {
                    setCarrinho([...carrinho, { idOriginal: item.id, nome: item.nome, origem, quantidade: 1, totalItem: preco }]);
                }
            };

            const removerDoCarrinho = (indexToRemove) => {
                setCarrinho(carrinho.filter((_, index) => index !== indexToRemove));
            };

            const finalizarVenda = () => {
                if (carrinho.length === 0) return;

                const insumosAtualizados = [...insumos];
                const produtosAtualizados = [...produtos];

                carrinho.forEach(itemVenda => {
                    if (itemVenda.origem === 'insumo') { 
                        const item = insumosAtualizados.find(i => i.id === itemVenda.idOriginal);
                        if (item) item.estoqueAtual -= itemVenda.quantidade;
                    } else { 
                        const item = produtosAtualizados.find(p => p.id === itemVenda.idOriginal);
                        if (item) item.estoqueAtual -= itemVenda.quantidade;
                    }
                });

                setInsumos(insumosAtualizados);
                setProdutos(produtosAtualizados);
                setHistoricoVendas([{ id: Date.now(), data: new Date().toLocaleString(), total: carrinho.reduce((a,b)=>a+b.totalItem,0), pagamento: metodoPagamento, itens: carrinho }, ...historicoVendas]);
                setCarrinho([]);
                alert("Venda registrada!");
            };

            const handleCustoFixoAdd = (e) => { e.preventDefault(); setCustosFixos([...custosFixos, {id: Date.now(), nome: formCustoFixo.nome, valor: parseFloat(formCustoFixo.valor)}]); setFormCustoFixo({nome:'', valor:''}); };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20">
                    
                    {/* Modal Reposição */}
                    <Modal isOpen={!!modalReposicao} onClose={() => setModalReposicao(null)} title="Repor Estoque">
                        <form onSubmit={handleRestock} className="space-y-4">
                            <p className="text-sm text-slate-500">Adicionando mais <strong>{modalReposicao?.nome}</strong>.</p>
                            <div>
                                <label className="text-xs font-bold text-slate-500">Qtd Comprada ({modalReposicao?.unidadeCompra})</label>
                                <input type="number" step="0.001" autoFocus className="w-full border rounded px-3 py-2 outline-none focus:border-emerald-500" placeholder="Ex: 5" value={formReposicao.qtd} onChange={e => setFormReposicao({...formReposicao, qtd: e.target.value})} />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500">Valor Total Pago (R$)</label>
                                <input type="number" step="0.01" className="w-full border rounded px-3 py-2 outline-none focus:border-emerald-500" placeholder="Ex: 20.00" value={formReposicao.preco} onChange={e => setFormReposicao({...formReposicao, preco: e.target.value})} />
                            </div>
                            <div className="flex gap-2 pt-2">
                                <button type="button" onClick={() => setModalReposicao(null)} className="flex-1 py-2 bg-slate-100 text-slate-600 font-bold rounded hover:bg-slate-200">Cancelar</button>
                                <button type="submit" className="flex-1 py-2 bg-emerald-600 text-white font-bold rounded hover:bg-emerald-700">Confirmar</button>
                            </div>
                        </form>
                    </Modal>

                    {/* Modal Exclusão */}
                    <Modal isOpen={!!itemParaExcluir} onClose={() => setItemParaExcluir(null)} title="Confirmar Exclusão">
                        <div className="space-y-4">
                            <div className="flex items-center gap-3 text-red-600 bg-red-50 p-3 rounded-lg">
                                <AlertTriangle className="w-6 h-6 flex-shrink-0" />
                                <p className="text-sm font-medium">Excluir <strong>{itemParaExcluir?.nome}</strong>?</p>
                            </div>
                            <p className="text-xs text-slate-500">Ação irreversível.</p>
                            <div className="flex gap-2 pt-2">
                                <button onClick={() => setItemParaExcluir(null)} className="flex-1 py-2 bg-slate-100 text-slate-600 font-bold rounded hover:bg-slate-200">Cancelar</button>
                                <button onClick={confirmarExclusao} className="flex-1 py-2 bg-red-600 text-white font-bold rounded hover:bg-red-700">Excluir</button>
                            </div>
                        </div>
                    </Modal>

                    <header className="bg-emerald-700 text-white shadow-lg sticky top-0 z-20">
                        <div className="max-w-6xl mx-auto px-4 py-4">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-emerald-600 rounded-lg"><ChefHat className="w-6 h-6 text-white" /></div>
                                    <div><h1 className="text-xl font-bold leading-none">ERP Gestor</h1><p className="text-emerald-100 text-xs mt-1">Controle Total</p></div>
                                </div>
                            </div>
                            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide -mx-4 px-4 sm:mx-0 sm:px-0">
                                {[
                                    { id: 'cadastro', icon: Package, label: '1. Cadastro' },
                                    { id: 'fabrica', icon: Factory, label: '2. Fábrica' },
                                    { id: 'estoque', icon: Boxes, label: '3. Estoque' },
                                    { id: 'custos', icon: Building2, label: '4. Custos' },
                                    { id: 'pdv', icon: ShoppingCart, label: '5. PDV' }
                                ].map(tab => (
                                    <button 
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)} 
                                        className={`flex-shrink-0 py-2 px-3 rounded-lg text-sm font-medium whitespace-nowrap flex items-center justify-center gap-2 transition-colors ${activeTab === tab.id ? 'bg-white text-emerald-800 shadow-sm' : 'bg-emerald-800/50 text-emerald-100 hover:bg-emerald-800'}`}
                                    >
                                        <tab.icon className="w-4 h-4" /> {tab.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-6 space-y-6">
                        {activeTab === 'cadastro' && (
                            <div className="grid md:grid-cols-5 gap-6 animate-in fade-in">
                                <div className="md:col-span-2 space-y-4">
                                    <Card className="p-5 border-t-4 border-t-emerald-500">
                                        <h2 className="text-lg font-semibold mb-4 flex items-center gap-2"><Plus className="w-5 h-5 text-emerald-600" /> Novo Item</h2>
                                        <form onSubmit={handleSubmitInsumo} className="space-y-4">
                                            <div className="flex gap-2">
                                                <button type="button" onClick={() => setFormInsumo({...formInsumo, tipo: 'compra'})} className={`flex-1 py-2 text-xs font-bold rounded border ${formInsumo.tipo === 'compra' ? 'bg-emerald-100 text-emerald-700 border-emerald-500' : 'bg-white text-slate-500'}`}>Matéria Prima</button>
                                                <button type="button" onClick={() => setFormInsumo({...formInsumo, tipo: 'revenda'})} className={`flex-1 py-2 text-xs font-bold rounded border ${formInsumo.tipo === 'revenda' ? 'bg-blue-100 text-blue-700 border-blue-500' : 'bg-white text-slate-500'}`}>Revenda</button>
                                            </div>
                                            <input type="text" placeholder="Nome" value={formInsumo.nome} onChange={e => setFormInsumo({...formInsumo, nome: e.target.value})} className="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-emerald-500" required />
                                            <div className="grid grid-cols-2 gap-3">
                                                <input type="number" step="0.01" placeholder="R$ Total" value={formInsumo.precoCompra} onChange={e => setFormInsumo({...formInsumo, precoCompra: e.target.value})} className="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-emerald-500" required />
                                                <input type="number" step="0.001" placeholder="Qtd" value={formInsumo.quantidadeCompra} onChange={e => setFormInsumo({...formInsumo, quantidadeCompra: e.target.value})} className="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-emerald-500" required />
                                            </div>
                                            <select value={formInsumo.unidadeCompra} onChange={e => setFormInsumo({...formInsumo, unidadeCompra: e.target.value})} className="w-full px-3 py-2 border rounded-lg bg-white outline-none">
                                                {unidades.map(u => <option key={u.value} value={u.value}>{u.label}</option>)}
                                            </select>
                                            {previewCalculo && (
                                                <div className="bg-slate-100 p-2 rounded text-center text-sm">
                                                    <strong className="text-emerald-700">{formatPrecision(previewCalculo.custoPorBase)} / {previewCalculo.unidadeBase}</strong>
                                                </div>
                                            )}
                                            <button type="submit" disabled={!previewCalculo} className="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold hover:bg-emerald-700">Salvar Item</button>
                                        </form>
                                    </Card>
                                </div>
                                <div className="md:col-span-3">
                                    <Card className="min-h-[400px]">
                                        <div className="p-4 border-b bg-slate-50"><h2 className="font-semibold text-slate-700">Inventário</h2></div>
                                        <div className="divide-y divide-slate-100 max-h-[600px] overflow-y-auto">
                                            {insumos.filter(i => i.tipo !== 'preparo').map(item => (
                                                <div key={item.id} className="p-4 flex justify-between items-center hover:bg-slate-50 group">
                                                    <div>
                                                        <div className="flex items-center gap-2">
                                                            <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold uppercase ${item.tipo === 'revenda' ? 'bg-blue-100 text-blue-700' : 'bg-slate-200 text-slate-600'}`}>{item.tipo}</span>
                                                            <h3 className="font-bold text-slate-700">{item.nome}</h3>
                                                        </div>
                                                        <div className="text-xs text-slate-500 mt-1 flex gap-3">
                                                            <span>Est: <strong>{item.estoqueAtual.toFixed(2)} {item.base.unidade}</strong></span>
                                                            <span className="text-slate-300">|</span>
                                                            <span>{formatPrecision(item.base.custo)}/{item.base.unidade}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <button onClick={() => setModalReposicao({id: item.id, nome: item.nome, unidadeCompra: item.compra?.unidade || 'un' })} className="bg-emerald-100 text-emerald-700 p-2 rounded-full"><Plus className="w-4 h-4"/></button>
                                                        <button onClick={() => setItemParaExcluir({ id: item.id, tipo: 'insumo', nome: item.nome })} className="text-slate-300 hover:text-red-500 p-2"><Trash2 className="w-4 h-4"/></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </Card>
                                </div>
                            </div>
                        )}

                        {activeTab === 'fabrica' && (
                            <div className="grid md:grid-cols-5 gap-6 animate-in fade-in">
                                <div className="md:col-span-3 space-y-4">
                                    <Card className="border-t-4 border-t-purple-500">
                                        <div className="p-4 border-b"><h2 className="font-bold text-purple-800 flex items-center gap-2"><UtensilsCrossed className="w-5 h-5"/> Nova Receita</h2></div>
                                        <div className="p-4 space-y-3">
                                            <input type="text" placeholder="Nome da Receita" value={formProduto.nome} onChange={e => setFormProduto({...formProduto, nome: e.target.value})} className="w-full px-3 py-2 border rounded outline-none" />
                                            <div className="flex gap-2">
                                                <select value={ingredienteSelecionado} onChange={e => setIngredienteSelecionado(e.target.value)} className="flex-1 border rounded px-2 py-2 bg-white text-sm outline-none">
                                                    <option value="">+ Ingrediente</option>
                                                    {insumos.filter(i => i.tipo !== 'revenda').map(i => <option key={i.id} value={i.id}>{i.nome} ({i.base.unidade})</option>)}
                                                </select>
                                                <input type="number" placeholder="Qtd" value={qtdIngrediente} onChange={e => setQtdIngrediente(e.target.value)} className="w-20 border rounded px-2 py-2 outline-none" />
                                                <button onClick={adicionarIngredienteAoProduto} className="bg-slate-800 text-white px-3 rounded text-sm">+</button>
                                            </div>
                                            <div className="bg-slate-50 rounded border border-slate-100 p-2 text-sm space-y-2 max-h-40 overflow-y-auto">
                                                {formProduto.ingredientes.map(ing => (
                                                    <div key={ing.tempId} className="flex justify-between items-center bg-white p-1 px-2 rounded border border-slate-100 shadow-sm">
                                                        <div className="flex items-center gap-2">
                                                            {ing.tipo === 'preparo' && <span className="text-[10px] bg-orange-100 text-orange-700 px-1 rounded font-bold">PREPARO</span>}
                                                            <span>{ing.nome} ({ing.qtdUsada}{ing.unidade})</span>
                                                        </div>
                                                        <div className="flex items-center gap-3">
                                                            <span className="font-bold">{formatPrecision(ing.custoCalculado)}</span>
                                                            <button onClick={() => removerIngredienteDoProduto(ing.tempId)} className="text-slate-300 hover:text-red-500"><X className="w-3 h-3"/></button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="pt-2 border-t flex flex-col gap-3">
                                                <span className="font-bold text-purple-900 text-sm">CMV Total: {formatCurrency(custoTotalProdutoAtual)}</span>
                                                <label className="flex items-center gap-2 p-2 border rounded bg-slate-50 cursor-pointer">
                                                    <input type="checkbox" checked={formProduto.isPreparo} onChange={e => setFormProduto({...formProduto, isPreparo: e.target.checked})} className="rounded text-purple-600" />
                                                    <div className="text-sm"><span className="font-bold block">É um Pré-Preparo?</span><span className="text-xs text-slate-500">Molhos, recheios...</span></div>
                                                </label>
                                                {formProduto.isPreparo && (
                                                    <div className="flex gap-2">
                                                        <input type="number" placeholder="Rendimento Final" value={formProduto.rendimentoFinal} onChange={e => setFormProduto({...formProduto, rendimentoFinal: e.target.value})} className="flex-1 border rounded px-2 py-1 text-sm" />
                                                        <select value={formProduto.unidadeRendimento} onChange={e => setFormProduto({...formProduto, unidadeRendimento: e.target.value})} className="border rounded px-2 py-1 text-sm bg-white">
                                                            {unidades.map(u => <option key={u.value} value={u.value}>{u.value}</option>)}
                                                        </select>
                                                    </div>
                                                )}
                                                <button onClick={salvarProduto} className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold">Salvar Receita</button>
                                            </div>
                                        </div>
                                    </Card>
                                </div>
                                <div className="md:col-span-2 space-y-4">
                                    <h3 className="font-bold text-slate-500 uppercase text-sm tracking-wider">Receitas Prontas</h3>
                                    {produtos.map(prod => (
                                        <Card key={prod.id} className={`hover:shadow-md transition-all ${prod.isPreparo ? 'border-l-4 border-l-orange-400' : 'border-l-4 border-l-purple-500'}`}>
                                            <div className="p-3">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h4 className="font-bold text-slate-800">{prod.nome}</h4>
                                                        <span className="text-[10px] text-slate-400">{prod.isPreparo ? 'Pré-Preparo' : 'Produto Final'}</span>
                                                    </div>
                                                    <button onClick={() => setItemParaExcluir({ id: prod.id, tipo: 'produto', nome: prod.nome })} className="text-slate-300 hover:text-red-500 p-1"><Trash2 className="w-4 h-4"/></button>
                                                </div>
                                                <div className="mt-2 text-xs font-bold text-slate-600">Custo Unitário: <span className="text-purple-700">{formatPrecision(prod.custoTotal)}</span></div>
                                                <div className="mt-3 pt-2 border-t flex gap-2">
                                                    {produtoEmProducao === prod.id ? (
                                                        <div className="flex-1 flex flex-col gap-2">
                                                            <div className="text-xs text-slate-500 flex justify-between"><span>Produzir:</span><span className="font-bold text-emerald-600">Máx: {maxProducao}</span></div>
                                                            <div className="flex gap-1">
                                                                <input type="number" placeholder="Qtd" autoFocus className="w-full border rounded px-1 text-center outline-none" value={producaoQtd} onChange={e => setProducaoQtd(e.target.value)} />
                                                                <button onClick={() => handleProduzir(prod)} className="flex-1 bg-emerald-600 text-white rounded text-xs font-bold px-2">OK</button>
                                                                <button onClick={() => setProdutoEmProducao(null)} className="px-2 bg-slate-200 text-slate-500 rounded text-xs">X</button>
                                                            </div>
                                                            {producaoQtd > 0 && (
                                                                <div className="bg-orange-50 p-2 rounded border border-orange-100 text-[10px] space-y-1">
                                                                    <div className="font-bold text-orange-800">Custo Lote: {formatCurrency(prod.custoTotal * parseFloat(producaoQtd))}</div>
                                                                    {prod.ingredientes.map(ing => (
                                                                        <div key={ing.tempId} className="flex justify-between"><span>- {ing.nome}:</span><span>{(ing.qtdUsada * parseFloat(producaoQtd)).toFixed(2)}{ing.unidade}</span></div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                    ) : (
                                                        <button onClick={() => iniciarProducao(prod)} className="flex-1 py-2 bg-slate-800 text-white rounded-lg text-xs font-medium flex items-center justify-center gap-2 hover:bg-slate-700"><Factory className="w-3 h-3" /> Produzir</button>
                                                    )}
                                                </div>
                                            </div>
                                        </Card>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'estoque' && (
                            <div className="animate-in fade-in space-y-4">
                                <div className="flex justify-between items-center overflow-x-auto pb-2 -mx-4 px-4 sm:mx-0 sm:px-0">
                                    <div className="flex gap-2">
                                        {['todos', 'produto', 'insumo', 'revenda', 'preparo'].map(filtro => (
                                            <button key={filtro} onClick={() => setFiltroEstoque(filtro)} className={`px-3 py-1 rounded-full text-sm whitespace-nowrap ${filtroEstoque === filtro ? 'bg-slate-800 text-white' : 'bg-white border text-slate-600'}`}>
                                                {filtro.charAt(0).toUpperCase() + filtro.slice(1)}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <Card className="overflow-hidden border-0 shadow-md">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left min-w-[600px]">
                                            <thead className="bg-slate-50 text-slate-500 font-bold uppercase text-xs border-b">
                                                <tr>
                                                    <th className="p-4">Item</th>
                                                    <th className="p-4">Tipo</th>
                                                    <th className="p-4">Estoque</th>
                                                    <th className="p-4">Custos (Base + Fixo)</th>
                                                    <th className="p-4 w-32">Preço Venda</th>
                                                    <th className="p-4">Lucro</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {[...produtos.filter(p => !p.isPreparo), ...insumos.filter(i => i.tipo !== 'compra')].filter(item => {
                                                    if(filtroEstoque === 'todos') return true;
                                                    if(filtroEstoque === 'produto' && item.rendimentoPadrao) return true; // check if product
                                                    if(filtroEstoque === 'revenda' && item.tipo === 'revenda') return true;
                                                    if(filtroEstoque === 'preparo' && item.tipo === 'preparo') return true;
                                                    if(filtroEstoque === 'insumo' && item.tipo === 'compra') return true;
                                                    return false;
                                                }).map(item => {
                                                    const isProduct = !!item.rendimentoPadrao && !item.tipo;
                                                    const baseCost = isProduct ? item.custoTotal : item.base.custo;
                                                    const preco = precosVenda[item.id] || 0;
                                                    const custoFixoUnitario = preco > 0 ? (preco * percentualCustoFixo / 100) : 0;
                                                    const lucro = preco - baseCost - custoFixoUnitario;
                                                    
                                                    return (
                                                        <tr key={item.id} className="hover:bg-slate-50">
                                                            <td className="p-4 font-bold text-slate-700">{item.nome}</td>
                                                            <td className="p-4"><span className="text-[10px] px-2 py-1 rounded-full font-bold bg-slate-100">{isProduct ? 'FABRICADO' : item.tipo.toUpperCase()}</span></td>
                                                            <td className="p-4 font-bold text-slate-600">{item.estoqueAtual.toFixed(2)}</td>
                                                            <td className="p-4">
                                                                <div className="flex flex-col gap-0.5">
                                                                    <span className="text-xs text-slate-400">Base: {formatPrecision(baseCost)}</span>
                                                                    <span className="text-xs text-sky-500">+ Fixo: {formatPrecision(custoFixoUnitario)}</span>
                                                                    <span className="font-bold text-slate-700 text-xs">= {formatCurrency(baseCost + custoFixoUnitario)}</span>
                                                                </div>
                                                            </td>
                                                            <td className="p-4">
                                                                <div className="flex items-center gap-1 border rounded-lg px-2 py-1 bg-white">
                                                                    <span className="text-slate-400 text-xs">R$</span>
                                                                    <input type="number" className="w-full outline-none text-sm font-semibold text-slate-700" placeholder="0.00" value={precosVenda[item.id] || ''} onChange={e => handlePrecoChange(item.id, e.target.value)} />
                                                                </div>
                                                            </td>
                                                            <td className={`p-4 font-bold ${lucro > 0 ? 'text-emerald-600' : 'text-red-500'}`}>
                                                                {preco > 0 ? formatCurrency(lucro) : '-'}
                                                            </td>
                                                        </tr>
                                                    )
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </Card>
                            </div>
                        )}

                        {activeTab === 'custos' && (
                            <div className="animate-in fade-in space-y-6">
                                <div className="bg-sky-50 border border-sky-200 rounded-lg p-5">
                                    <h3 className="text-sky-900 font-bold text-lg">Faturamento Estimado</h3>
                                    <input type="number" value={faturamentoEstimado} onChange={e => setFaturamentoEstimado(e.target.value)} className="w-full pl-3 py-2 border rounded mt-2" placeholder="Ex: 20000.00"/>
                                    <div className="mt-2 text-3xl font-bold text-sky-600">{formatPercent(percentualCustoFixo)} <span className="text-sm font-normal text-slate-500">de Custo Fixo</span></div>
                                </div>
                                <div className="grid md:grid-cols-2 gap-6">
                                    <Card className="p-5">
                                        <h3 className="font-bold mb-4">Adicionar Despesa</h3>
                                        <form onSubmit={handleCustoFixoAdd} className="space-y-3">
                                            <input type="text" placeholder="Nome" value={formCustoFixo.nome} onChange={e => setFormCustoFixo({...formCustoFixo, nome: e.target.value})} className="w-full border rounded px-3 py-2" />
                                            <input type="number" placeholder="Valor" value={formCustoFixo.valor} onChange={e => setFormCustoFixo({...formCustoFixo, valor: e.target.value})} className="w-full border rounded px-3 py-2" />
                                            <button className="w-full bg-sky-600 text-white py-2 rounded font-bold">Adicionar</button>
                                        </form>
                                    </Card>
                                    <Card className="p-0">
                                        <div className="divide-y max-h-64 overflow-y-auto">
                                            {custosFixos.map(c => (
                                                <div key={c.id} className="p-3 flex justify-between hover:bg-slate-50 items-center">
                                                    <span>{c.nome}</span>
                                                    <div className="flex items-center gap-3">
                                                        <span className="font-bold">{formatCurrency(c.valor)}</span>
                                                        <button onClick={() => setItemParaExcluir({id: c.id, tipo: 'custoFixo', nome: c.nome})} className="text-red-300 hover:text-red-500"><Trash2 className="w-4 h-4"/></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </Card>
                                </div>
                            </div>
                        )}

                        {activeTab === 'pdv' && (
                            <div className="grid md:grid-cols-3 gap-6 animate-in fade-in">
                                <div className="md:col-span-2 space-y-6">
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                        {[...produtos.filter(p => !p.isPreparo), ...insumos.filter(i => i.tipo === 'revenda')].filter(item => precosVenda[item.id] > 0).map(item => (
                                            <button key={item.id} onClick={() => adicionarAoCarrinho(item, item.tipo === 'revenda' ? 'insumo' : 'produto')} className="bg-white border hover:border-emerald-500 p-3 rounded-lg text-left shadow-sm hover:shadow-md transition-all active:scale-95 relative overflow-hidden">
                                                <div className="font-bold text-slate-700 leading-tight">{item.nome}</div>
                                                <div className={`text-xs mt-1 font-bold ${item.estoqueAtual > 0 ? 'text-emerald-600' : 'text-red-500'}`}>Est: {item.estoqueAtual}</div>
                                                <div className="mt-2 text-lg font-bold text-emerald-700">{formatCurrency(precosVenda[item.id])}</div>
                                                {item.estoqueAtual <= 0 && <div className="absolute top-0 right-0 bg-red-100 text-red-600 text-[10px] px-2 py-0.5 rounded-bl font-bold">Sem Estoque</div>}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="bg-white rounded border border-slate-200 divide-y max-h-60 overflow-y-auto">
                                        {historicoVendas.map(venda => (
                                            <div key={venda.id} className="p-3 flex justify-between items-center text-sm">
                                                <div><div className="font-bold text-slate-700">#{venda.id.toString().slice(-4)}</div><div className="text-xs text-slate-400">{venda.data}</div></div>
                                                <div className="font-bold text-emerald-600">{formatCurrency(venda.total)}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="md:col-span-1">
                                    <Card className="h-full flex flex-col border-emerald-500 border-t-4 shadow-lg">
                                        <div className="p-3 bg-emerald-50 border-b flex justify-between items-center">
                                            <h2 className="font-bold text-emerald-900 flex items-center gap-2"><ShoppingCart className="w-5 h-5" /> Caixa</h2>
                                            <button onClick={() => setCarrinho([])} className="text-xs text-red-500">Limpar</button>
                                        </div>
                                        <div className="flex-1 p-3 overflow-y-auto min-h-[300px] space-y-2 max-h-[50vh] md:max-h-none">
                                            {carrinho.map((item, idx) => (
                                                <div key={idx} className="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-100">
                                                    <div><div className="font-bold text-slate-700 text-sm">{item.nome}</div><div className="text-xs text-slate-500">{item.quantidade}x {formatCurrency(item.totalItem/item.quantidade)}</div></div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="font-bold text-slate-700">{formatCurrency(item.totalItem)}</span>
                                                        <button onClick={() => removerDoCarrinho(idx)} className="text-slate-300 hover:text-red-500 p-1"><Trash2 className="w-4 h-4" /></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="p-4 bg-white border-t space-y-3 sticky bottom-0">
                                            <div className="flex justify-between text-xl font-bold text-emerald-700"><span>Total</span><span>{formatCurrency(carrinho.reduce((a,b)=>a+b.totalItem,0))}</span></div>
                                            <div className="grid grid-cols-3 gap-2">
                                                {['dinheiro', 'pix', 'cartao'].map(m => (
                                                    <button key={m} onClick={() => setMetodoPagamento(m)} className={`text-xs uppercase font-bold py-2 border rounded ${metodoPagamento === m ? 'bg-emerald-600 text-white' : 'bg-white'}`}>{m}</button>
                                                ))}
                                            </div>
                                            <button onClick={finalizarVenda} disabled={carrinho.length===0} className="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold hover:bg-emerald-700 disabled:bg-slate-300">Finalizar</button>
                                        </div>
                                    </Card>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
